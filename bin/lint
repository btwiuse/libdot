#!/usr/bin/env python3
# -*- coding: utf-8 -*-
# Copyright 2019 The Chromium OS Authors. All rights reserved.
# Use of this source code is governed by a BSD-style license that can be
# found in the LICENSE file.

"""Lint our source files."""

from __future__ import print_function

import glob
import os
import sys

import libdot


# All checks except strictMissingRequire.
DEFAULT_CLOSURE_ARGS = (
    '--jscomp_error=*', '--jscomp_off=strictMissingRequire')


def _get_default_paths():
    """Get list of paths to lint by default."""
    # All files in js/*.js excluding generated files.
    # Use relpath for nicer default output.
    # Sort to ensure lib.js comes before lib_array.js, etc.
    return sorted(
        os.path.relpath(x, os.getcwd())
        for x in glob.glob(os.path.join(libdot.DIR, 'js', '*.js'))
        if x != 'js/libdot.js')


def main(argv, paths=(), eslint_args=(), closure_args=DEFAULT_CLOSURE_ARGS):
    """The common main func for all linters.

    Args:
      argv: The command line to process.
      get_default_paths: Function to get all the default set of files to lint.
          If the user doesn't specify any, we'll get them from here.
      eslint_args: Extra arguments to pass to eslint.
      closure_args: Extra arguments to pass to closure-compiler.
    """
    libdot.setup_logging()
    libdot.node_and_npm_setup()

    if not argv:
        if paths:
            argv = paths
        else:
            print('No files to lint.')
            return 0

    # We know our tools are first in $PATH now.
    libdot.run(['eslint'] + list(eslint_args) + argv)
    # TODO(crbug.com/998928): Update checks beyond just 'lintChecks'.
    # E.g. --jscomp_error=*.
    libdot.run([
        os.path.join(libdot.BIN_DIR, 'closure-compiler'),
        '--checks-only', '--language_in=ECMASCRIPT_2018'] +
               list(closure_args) + argv)

    return 0


if __name__ == '__main__':
    sys.exit(main(sys.argv[1:], paths=_get_default_paths(),
                  closure_args=['--jscomp_error=lintChecks']))

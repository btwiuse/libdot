#!/bin/bash
# Copyright 2018 The Chromium OS Authors. All rights reserved.
# Use of this source code is governed by a BSD-style license that can be
# found in the LICENSE file.

LIBDOT_DIR="$(dirname -- "$0")/../../libdot"
source "${LIBDOT_DIR}/bin/common.sh"

main() {
  local tar="node_modules.tar"
  pushd "${LIBAPPS_DIR}" >/dev/null

  echo_err "Removing modules not listed in package.json"
  npm prune

  echo_err "Updating modules from package.json"
  npm upgrade --no-save

  echo_err "Creating tarball"
  tar -cf "${tar}" \
    --exclude='node_modules/.hash' \
    --exclude='node_modules/.node/*' \
    --exclude='node_modules/.bin/node' \
    --exclude='node_modules/.bin/npm' \
    node_modules || exit

  echo_err "Compressing tarball"
  xz -T0 -9 "${tar}" || exit

  local hash=$(sha256sum <"${tar}.xz" | awk '{print $1}')
  local final_tar="node_modules-${hash}.tar.xz"
  mv "${tar}.xz" "${final_tar}"
  du -h "${final_tar}"

  echo_err "To update the hash, run:"
  echo "sed -i \"/^NODE_MODULES_HASH=/s:=.*:='${hash}':\" '${LIBDOT_BIN_DIR}/node.sh'"
  echo_err "To upload the new modules:"
  echo "gsutil cp -a public-read ${final_tar} ${NODE_MODULES_GS_URI}/"

  popd >/dev/null
}
main "$@"
